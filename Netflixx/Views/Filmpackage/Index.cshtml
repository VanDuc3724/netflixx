@model IEnumerable<Netflixx.Models.PackagesModel>
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<AppUserModel> UserManager
@inject Netflixx.Repositories.DBContext DBContext
@{
    ViewData["Title"] = "Film Packages";
    Layout = "_Layout";
}
@section Styles {
    <link rel="stylesheet" href="~/css/FPackage.css" />
}
<main>
    <div class="page-title">
        <h1>Danh S√°ch G√≥i Phim</h1>
        <p>Ch·ªçn g√≥i ph√π h·ª£p ƒë·ªÉ xem c√°c b·ªô phim y√™u th√≠ch v·ªõi m·ª©c gi√° ti·∫øt ki·ªám.</p>
    </div>
    <div class="text-center mb-4">
        <a asp-action="Billhistory" class="purchase-history-btn">L·ªãch s·ª≠ mua g√≥i</a>
        <a asp-controller="PackagesManager" asp-action="Create" class="create-package-btn">T·∫°o g√≥i m·ªõi</a>
    </div>
    <div class="package-container">
        @foreach (var p in Model)
        {
            var user = await UserManager.GetUserAsync(User);
            bool owned = false;
            if (user != null)
            {
                owned = await DBContext.PackageSubscriptions
                    .AnyAsync(ps => ps.UserID == user.Id && ps.PackageID == p.Id && ps.EndDate >= DateTime.UtcNow);
            }
            <div class="package-card">
                <div class="package-header @(p.Name.ToLower())">
                    <h2>@p.Name</h2>
                    <div class="price">@p.Price.ToString("N0") <span>coins</span></div>
                </div>
                <div class="film-count">Bao g·ªìm @p.PackageFilms?.Count ?? 0 phim</div>
                <div class="package-features">
                    @foreach (var pf in p.PackageFilms ?? new List<Netflixx.Models.PackageFilmsModel>())
                    {
                        <div class="feature">
                            <span class="feature-icon">üé¨</span>
                            <span class="feature-text">@pf.Film?.Title</span>
                        </div>
                    }
                </div>
                @if (owned)
                {
                    <a asp-controller="Film" asp-action="Type" class="btn btn-success w-75 mb-3">ƒê√£ s·ªü h·ªØu</a>
                }
                else
                {
                    <form asp-action="BuyWithCoins" method="post" class="buy-form">
                        <input type="hidden" name="packageId" value="@p.Id" />
                        <button type="submit" class="btn btn-primary w-75 mb-3">Mua g√≥i</button>
                    </form>
                }
            </div>
        }
    </div>
</main>

@section Scripts {
    @await Html.PartialAsync("_NotificationPartial")
    <script>
        document.querySelectorAll('.buy-form').forEach(function(form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                Swal.fire({
                    title: 'X√°c nh·∫≠n mua g√≥i?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#e50914',
                    confirmButtonText: 'Mua',
                    cancelButtonText: 'H·ªßy'
                }).then(function (result) {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });
    </script>
}
